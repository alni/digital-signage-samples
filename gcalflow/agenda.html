<html>
<head>
    <!--
        Supports the following URI Query Parameters:
        * CAL_ID : (required) the ID of the Calendar from the Google Calendar
          Service
        * DATE_FORMAT : (optional) the Moment.js format to use with the dates
            * Default : "ddd, ll"
        * LANG : (optional) the language to use with Moment.js
            * Default : nb (Norwegian Bokmaal)
        * TYPE : (optional) type of agenda (normal/grouped)
            * normal : normal agenda (default)
            * grouped : group agenda items by date range (supports only date +
              title)
            * tasks : use the agenda as a simple tasks/todo list (supports only
              date, title and location)
            * ticker : use the agenda as a news ticker (supports only date,
              title and location)
        * INTERVAL : (optional) the scroll interval in seconds
            * Default : 10
        * MAX_ITEMS : (optional) the number of max items to fetch from the
          calendar
            * Default : 50
        * NUM_DAYS : (optional) the number of days in the future to fetch
          events from the calendar.
          - If this is not specified, then MAX_ITEMS is used instead.
          - The value must to be greater than "0". If not, the value will be
            forced to "1"
        * FA_ICON : (optional) the Font Awesome icon to use together with the
          Title/Header block. This could be any name or alias of an icon that
          is included with Font Awesome 4.5.0 (like "calendar").
        * HIDE : (optional) what event item parts should be hidden? A comma
          separated value list of parts to hide.
            * "title" : hide the event title/summary
            * "location" : hide the event location
            * "daterange" : hide the start and end date/time of the event
            * "description" : hide the event description
            * Default : "description" (hide the description if not set)
        * ICON_ONLY : (optional) should the Title/Header block show the icon
          only/hide the text? This is only used when also the "FA_ICON"
          parameter is also provided.


        Examples:
            agenda.html?CAL_ID=<my_calendar_id>&LANG=en&DATE_FORMAT=lll
              * Agenda with English date and time, with a medium length,
                localized date format
            agenda.html?CAL_ID=<my_calendar_id>&LANG=da&DATE_FORMAT=lll&TYPE=grouped
              *  Grouped agenda with Danish date and time, and a medium length,
                 localized date format
    -->
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="styles/loader.css">
</head>
<body>
    <div id="loader-wrapper">
        <div id="loader"></div>

        <div class="loader-section section-left"></div>
        <div class="loader-section section-right"></div>
    </div>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href="jquery-gcal-flow-3.0.2/jquery.gcal_flow.css" rel="stylesheet" type="text/css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="../shared/lib/jquery.transit.min.js" charset="UTF-8"></script>
    <script>
        _gCalFlow_debug = true;
    </script>
    <script type="text/javascript" src="../shared/lib/moment-with-locales.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="private.js" charset="utf-8"></script>
    <!--<script type="text/javascript" src="jquery-gcal-flow-3.0.1/jquery.gcal_flow.js"></script>-->
    <script type="text/javascript" src="jquery.gcal_flow_custom.js"></script>
    <script type="text/javascript">
        /**
         * http://lions-mark.com/jquery/scrollTo/
         */
        $.fn.scrollTo = function (target, options, callback) {
            if (typeof options == 'function' && arguments.length == 2) { callback = options; options = target; }
            var settings = $.extend({
                scrollTarget: target,
                offsetTop: 50,
                duration: 500,
                easing: 'swing'
            }, options);
            return this.each(function () {
                var scrollPane = $(this);
                var scrollTarget = (typeof settings.scrollTarget == "number") ? settings.scrollTarget : $(settings.scrollTarget);
                var scrollY = (typeof scrollTarget == "number") ? scrollTarget : scrollTarget.offset().top + scrollPane.scrollTop() - parseInt(settings.offsetTop);
                scrollPane.animate({ scrollTop: scrollY }, parseInt(settings.duration), settings.easing, function () {
                    if (typeof callback == 'function') { callback.call(this); }
                });
            });
        }
    </script>
    <script type="text/javascript">
        /**
         * <http://stackoverflow.com/a/5158301>
         */
        function getParameterByName(name) {
            var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }

        /**
         * <https://stackoverflow.com/a/37369700>
         */
        function plaintext(html) {
            return $("<div/>").html(html).text();
        }

        var $ = jQuery;
        $(function () {
            var THEME_COLOR = getParameterByName("THEME_COLOR") || null;
            if (THEME_COLOR) {
                switch (THEME_COLOR) {
                    case "green":
                    case "red":
                    case "dark":
                        $("#loader-wrapper, #gcf-custom-template")
                            .addClass("theme-" + THEME_COLOR);
                        break;
                }
            }
            var API_KEY = window.GOOGLE_CALENDAR_API_KEY || null;

            var CAL_ID = getParameterByName("CAL_ID");
            if (!!CAL_ID) {
                initAgenda(CAL_ID, API_KEY);
            }
        });
        function hideScrollButtons(hide) {
            if (!!hide) {
                $(".scroll_btns").addClass("hidden");
            }
        }
        function ResponsiveTabbedNavigation_NextTab() {
            var _parent = window.parent;
            while (!("ResponsiveTabbedNavigation" in _parent)) {
                try {
                    // Check has access to the properties of the parent of
                    // _parent (If no error is thrown, then it is on the same
                    // domain, otherwise it is on a different domain)
                    if ("document" in _parent.parent) {
                        // We have access!
                        _parent = _parent.parent; // Set as its own parent!
                    } 
                } catch (ex) {
                    // If an error is thrown then the parent of _parent is on a
                    // different domain!
                    break; // Break out of the loop
                }
                
            }
            if ("ResponsiveTabbedNavigation" in _parent) {
                _parent.postMessage("next-tab", window.location.origin);
            }
        }
        /**
          * Called when the calendar events has been added and the events has
          * been processed. Also Set the refresh timer (if any) to reload the
          * page after a set amount of minutes.
          * @param {Number} refresh - the number of minutes to wait before
          *     reloading the page
          */
        function loadComplete($items, refresh) {
            $("body").addClass("loaded"); // hide the loading screen
            if (!!window.navigator.userAgent.match(/MSIE|Trident|Edge/)) {
                // Internet Explorer found!
                /* < IE11 = "MSIE"
                 *   IE11 = "Trident"
                 * > IE11 = "Edge" (IE12 (Edge), Edge 13 etc...)
                 */

                // IE 11 does not fire the ease-out animation of the Loader
                // Wrapper (with "transform: translateY(-100%)") correctly, so
                // we need to do this with JS instead
                $("#loader-wrapper").transition({
                    y: "-100%",
                }, 300, "ease", function() {
                    $(this).hide(0); // Finally, hide the element
                });
                /*$(".loader-section").transition({
                    opacity: 0.0
                }, 300, "ease");*/
            }
            hideScrollButtons($items.length <= 1);
            $('.gcf-item-container-block').on("autoscroll:end", function(e) {
                ResponsiveTabbedNavigation_NextTab();
            });
            if (!!refresh && refresh >= 1) {
                setTimeout(function () {
                    window.location.reload();
                }, refresh * 60000);
            }
        }
        function scrollList(bUp) {
            var $root = $('#gcf-custom-template .gcf-item-container-block');
            var $item;
            if (bUp) {
                console.error("    ");
                $item = $root.find(".gcf-item-block").filter(function () {
                    console.error($(this).position().top);
                    return parseInt($(this).position().top) < 0;
                }).last();
                console.error("    ");
                console.error($item.position().top);
                $root.scrollTo($item[0].offsetTop, {
                    offsetTop: 0,
                    duration: 250
                });
            } else {
                console.error("    ");
                $item = $root.find(".gcf-item-block").filter(function () {
                    console.error($(this).position().top);
                    return parseInt($(this).position().top) > 0;
                }).first();
                console.error("    ");
                console.error($item.position().top);
                $root.scrollTo($item[0].offsetTop, {
                    offsetTop: 0,
                    duration: 250
                });
            }
            
            //$root.scrollTop($item.find(".gcf-item-header-block").offset().top);
            //$root.scrollTop($root.scrollTop() - 42);
            /*var _gcalflow = $("#gcf-custom-template").data('gCalFlow').obj;
            var idx = _gcalflow._tmpIdx || 0;
            if (bUp) {
                idx -= 1;
            } else {
                idx += 1;
            }
            if (idx < 0 ) {
                idx = 0;
            }
            console.error(idx);
            _gcalflow._tmpIdx = _gcalflow.bind_scroll(true, bUp, idx);*/
        }
        function initAgenda(CAL_ID, API_KEY) {
            var DATA_URL = getParameterByName("DATA_URL");
            var DATE_FORMAT = getParameterByName("DATE_FORMAT") || "ddd, ll";
            var LANG = getParameterByName("LANG") || "nb";
            var TYPE = getParameterByName("TYPE") || null;
            var SCROLL_INTERVAL = getParameterByName("INTERVAL") || 10;
            var MAX_ITEMS = getParameterByName("MAX_ITEMS") || 50;
            var NUM_DAYS = getParameterByName("NUM_DAYS") || null;
            var FA_ICON = getParameterByName("FA_ICON") || null;
            var CUSTOM_ICON = getParameterByName("CUSTOM_ICON") || null;
            var ICON_ONLY = getParameterByName("ICON_ONLY") || false;
            var HIDE = (getParameterByName("HIDE") || "description").split(",");
            var REFRESH_AFTER = getParameterByName("REFRESH_AFTER") || null;
            var GAS_ID = getParameterByName("GAS_ID") || null;
            var GAS_DEV_ID = getParameterByName("GAS_DEV_ID") || null;
            var GAS_SECRET = getParameterByName("GAS_SECRET") || null;
            var dtstart = new Date();
            var dtend = null;
            var autoscroll = true;
            var show_enddate = true;
            var callback = null;
            if (+SCROLL_INTERVAL <= 0) {
                // If the numeric value of SCROLL_INTERVAL is less than or equal
                // to "0" then disable auto scrolling
                autoscroll = false;
            }
            if (NUM_DAYS !== null && +NUM_DAYS < 1) {
                // If NUM_DAYS is set to a value, but the numeric value is less
                // than "1", then set it to the minimum value of "1"
                NUM_DAYS = 1;
            }
            if (REFRESH_AFTER !== null && +REFRESH_AFTER < 1) {
                // If REFRESH_AFTER is set to a value, but the numeric value is
                // less than "1", then disable automatic refresh by setting it
                // to a value of "null"
                REFRESH_AFTER = null;
            } else {
                // Otherwise, set REFRESH_AFTER to its numeric value
                REFRESH_AFTER = +REFRESH_AFTER; // minutes
            }
            if (CUSTOM_ICON) {
                // If CUSTOM_ICON is defined, then use it as a title block icon
                if (ICON_ONLY) {
                    // If ICON_ONLY is defined, then hide the title text element
                    $(".gcf-title").addClass("hidden");
                    $(".gcf-title-block").prepend("&nbsp;")
                }
                // Add an Image element, with the custom icon as Source with a
                // CSS class of "custom-icon", to the title block
                $(".gcf-title-block").prepend("&nbsp;<img src=\"" + CUSTOM_ICON + "\" class=\"custom-icon\" />&nbsp;");
            } else if (FA_ICON) {
                // Otherwise, if FA_ICON is defined, then use it as a title
                // block icon
                if (ICON_ONLY) {
                    // If ICON_ONLY is defined, then hide the title text element
                    $(".gcf-title").addClass("hidden");
                    $(".gcf-title-block").prepend("&nbsp;")
                }
                FA_ICON = FA_ICON.split(","); // Split the FA_ICON into a list

                if (FA_ICON.length > 1) {
                    // If it contains more than 1 element, then create a Font
                    // Awesome icon stack out of them
                    var $fa_stack = $("<span/>");
                    $fa_stack.addClass("fa-stack"); // add icon stack class
                    $.each(FA_ICON, function (index, icon) {
                        // Loop through each icon and add a icon stack size in
                        // reversed order (first = largest, last = smallest)
                        var fa_stack_class = "fa-stack-" + (FA_ICON.length - index) + "x";
                        if (index === 0) {
                            // If it is the first icon, then add a Large icon
                            // CSS class
                            fa_stack_class += " fa-lg";
                        }
                        // Append the icon, with classes, to the icon stack
                        $fa_stack.append("<i class=\"fa fa-" + icon + " " + fa_stack_class + "\"></i>");
                    });
                    // Add a SPAN element with "icon" class as the first element
                    // of the title block
                    $(".gcf-title-block").prepend($("<span/>").addClass("icon")).prepend("&nbsp;");
                    // Add the icon stack to the "SPAN" with the "icon" class
                    $(".gcf-title-block span.icon").append($fa_stack);
                } else {
                    // Otherwise, if the it contains only 1 element, then set
                    // FA_ICON as the first (only) element
                    FA_ICON = FA_ICON[0];
                    // Add the icon, with classes, as the first element of the
                    // title block
                    $(".gcf-title-block").prepend("&nbsp;<i class=\"fa fa-" + FA_ICON + " fa-fw\">&nbsp;</i>");
                }
            }
            $.each(HIDE, function (index, hide) {
                // Loop through each item of the HIDE parameter
                switch (hide) {
                    case "scrollbars":
                        // Hide the scroll bars
                        $("body").addClass("hide-scrollbars");
                        break;
                    case "title":
                        // Hide the title of the items
                        $(".gcf-item-title").addClass("hidden");
                        break;
                    case "location":
                        // Hide the location of the items
                        $(".gcf-item-location").addClass("hidden");
                        // Remove the BR before location to move the elements
                        // following a bit upwards
                        $(".gcf-item-location").prev("br").remove();
                        break;
                    case "daterange":
                        // Hide the start and end dates (daterange) of the items
                        $(".gcf-item-daterange").addClass("hidden");
                        break;
                    case "description":
                        // Hide the description of the items
                        $(".gcf-item-description").addClass("hidden");
                        break;
                    case "enddate":
                        // Hide only the end date of the items
                        show_enddate = false;
                        break;
                }
            });

            switch (TYPE) {
                // Check what kind of TYPE we should use
                case "grouped":
                    // group agenda items by date range (supports only date +
                    // title)
                    callback = function () {
                        var found_dates = [];
                        var $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            var $this = $(this),
                                $date = $this.find(".gcf-item-daterange"),
                                _date = $date.text(),
                                $title = $this.find('.gcf-item-title'),
                                $location = $this.find('.gcf-item-location'),
                                $desc = $this.find(".gcf-item-description"),
                                $prev = $this.prev(),
                                $prev_title = $prev.find('.gcf-item-title'),
                                $prev_location = $prev.find('.gcf-item-location');
                            if (!$desc.hasClass("hidden") && $desc.text()) {
                                // Convert description text to HTML. But only
                                // when the Description is not hidden.
                                $desc.html($.parseHTML($desc.text()));
                            }
                            if (found_dates.indexOf(_date) > -1) {
                                // If the date of the current item is already
                                // found, then group it with the previous
                                //$this.find(".gcf-item-daterange").text("");
                                //$this.find("hr").remove();

                                if ($prev_title.text() != $title.text() &&
                                    $location.text() == $prev_location.text()) {
                                    // The title is different from previous,
                                    // but the location is the same:
                                    // - append the title to the previous
                                    $prev_title.append('<br/>')
                                        .append($title.text());
                                    $this.remove();
                                } else if ($prev_title.text() == $title.text() &&
                                    $location.text() != $prev_location.text()) {
                                    // The location is different from previous,
                                    // but the title is the same:
                                    // - append the location to the previous
                                    $prev_location.append('<br/>')
                                        .append($location.text());
                                    $this.remove();
                                } else {
                                    // Both title AND location is different
                                    // from the previous - Do nothing...
                                }
                                //$this.html("").addClass("hidden");
                                //$this.remove();
                            } else {
                                // If the date of the current item is not already
                                // found, then add it as a new entry to the
                                // "found_dates" array
                                found_dates.push(_date);
                                // Remove the HR from the item and prepend a new
                                // HR to the item
                                $this.find("hr").remove();
                                $this.prepend("<hr />");
                            }
                            if (NUM_DAYS == 1) {
                                $date.addClass("hidden");
                                $this.find("hr").remove();
                                $this.find("br:first").remove();
                            }
                        });
                        
                        loadComplete($items);
                        //$("body").addClass("loaded"); // hide the loading screen
                        //hideScrollButtons($items.length <= 1);
                    };
                    break;
                case "grouped-alt":
                    // an alternative `grouped` type with similar
                    // grouping behaviour and styles as the "tasks"
                    // type
                    $('#gcf-custom-template').addClass("tasks")
                        .addClass("grouped-alt");
                    callback = function () {
                        var found_dates = [];
                        var $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            var $this = $(this),
                                $date = $this.find(".gcf-item-daterange"),
                                _date = $date.text(),
                                $header_block = $this.find(".gcf-item-header-block"),
                                $desc = $this.find(".gcf-item-description"),
                                $prev = $this.prev();
                            if (!$desc.hasClass("hidden") && $desc.text()) {
                                // Convert description text to HTML. But only
                                // when the Description is not hidden.
                                $desc.html($.parseHTML($desc.text()));
                            }
                            // Remove the BR elements to keep all elements on
                            // the same line within the item
                            $this.find("br").remove();
                            if (found_dates.indexOf(_date) > -1) {
                                // If the date of the current item is already
                                // found, then group it with the previous
                                $this.find(".gcf-item-daterange").addClass("hidden");
                                $prev.append($header_block.detach());
                                $this.remove();
                            } else {
                                // Otherwise, add the date/time as a new entry
                                // with the found_dates array
                                found_dates.push(_date);

                                // Use this element as a daterange group header
                                // for other elements

                                // Remove the bottom HR element
                                $this.find("hr").remove(); // Remove bottom
                                $this.find(".gcf-item-daterange").after("<br />");
                                // and add another at the top of the element
                                $this.prepend("<hr />"); // Add at top
                            }
                            if (NUM_DAYS == 1) {
                                $date.addClass("hidden");
                                $this.find("hr").remove();
                                $this.find("br:first").remove();
                            }
                        });

                        loadComplete($items);
                        //$("body").addClass("loaded"); // hide the loading screen
                        //hideScrollButtons($items.length <= 1);
                    };
                    break;
                case "tasks":
                    // use the agenda as a simple tasks/todo list (supports only
                    // date, title and location)
                    autoscroll = false;
                    // Set the dtstart to the start of the day
                    dtstart.setHours(0);
                    dtstart.setMinutes(0);
                    dtstart.setSeconds(0);
                    dtstart.setMilliseconds(0);
                    //dtend = moment(dtstart).endOf('day').toDate();
                    // Default NUM_DAYS to 1 of not already set to a value
                    NUM_DAYS = NUM_DAYS || 1;
                    $('#gcf-custom-template').on('click', '.gcf-item-block[data-event-id]', function (e) {
                        var $this = $(this); // The task item
                        // The key to use with localStorage
                        var key = "agenda-tasks-" + $this.data("event-id") + "_done";
                        // Toogle DONE state of the task item when clicked/tapped
                        $this.toggleClass("disabled");
                        var isDone = $this.hasClass("disabled");
                        if ($this.hasClass("disabled")) {
                            $this.find(".gcf-item-title > i.fa")
                                .removeClass("fa-square-o")
                                .addClass("fa-check-square-o");
                        } else {
                            $this.find(".gcf-item-title > i.fa")
                                .removeClass("fa-check-square-o")
                                .addClass("fa-square-o");
                        }
                        // If GAS_ID, or GAS_DEV_ID, and GAS_SECRET is provided
                        // then use "Calendar Task List" Google Apps Script
                        // project to sync the done state of the task item with
                        // the script
                        if ((GAS_ID || GAS_DEV_ID) && GAS_SECRET) {
                            // Default URL (used with GAS_ID)
                            var url = "https://script.google.com/macros/s/"
                                + GAS_ID + "/exec?callback=?";
                            if (GAS_DEV_ID) {
                                // IF GAS_DEV_ID is provided then override the
                                // default URL with the development variant
                                url = "https://script.google.com/macros/s/"
                                    + GAS_DEV_ID + "/dev?callback=?";
                            }
                            // Data to send to Google Apps Script
                            var data = {
                                "SECRET_KEY": GAS_SECRET,
                                "CALENDAR_ID": CAL_ID,
                                "EVENT_ID": $this.data("event-id"),
                                "START_DT": $this.data("start")
                            };
                            if (isDone) {
                                // If the task is done, then also send the
                                // "IS_DONE" parameter with the data
                                data["IS_DONE"] = "true";
                            }
                            // Send the data to Google Apps Script
                            $.getJSON(url, data).done(function (e) {
                                // TODO: Notify the user that it was successful
                            });
                        }
                        // Store the serialized task done state (has "disabled"
                        // class) in localStorage
                        localStorage.setItem(key, JSON.stringify($this.hasClass("disabled")));
                    });
                    $('#gcf-custom-template').addClass("tasks");

                    callback = function () {
                        var found_dates = [],
                            $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            // Loop through each task item and check for stored
                            // DONE state
                            var $this = $(this); // The task item
                            $this.find(".gcf-item-title").prepend("<i class=\"fa fa-square-o\">&nbsp;</i>");
                            // If GAS_ID, or GAS_DEV_ID, and GAS_SECRET is
                            // provided then check if the task item is done
                            if ((GAS_ID || GAS_DEV_ID) && GAS_SECRET) {
                                if ($this.attr("data-exprop-task-state") === "done") {
                                    // If it is done, then style and mark it as
                                    // so
                                    $this.addClass("disabled");
                                    $this.find(".gcf-item-title > i.fa")
                                        .removeClass("fa-square-o")
                                        .addClass("fa-check-square-o");
                                }
                            } else {
                                // Otherwise, check if the task item is done via
                                // the LocalStorage
                                
                                // The key to use with localStorage
                                var key = "agenda-tasks-" + $this.data("event-id") + "_done";
                                // Check if key exists in localStorage
                                if (key in localStorage) {
                                    // Then check its parsed value
                                    if (!!JSON.parse(localStorage.getItem(key))) {
                                        // If the parsed value validates to true,
                                        // then set the task as already done (add
                                        // "disabled" class)
                                        $this.addClass("disabled");
                                        $this.find(".gcf-item-title > i.fa")
                                            .removeClass("fa-square-o")
                                            .addClass("fa-check-square-o");
                                    }
                                }
                            }
                            
                            var _date = $this.find(".gcf-item-daterange").text();
                            // Remove the BR elements to keep all elements on
                            // the same line within the item
                            $this.find("br").remove();
                            if (found_dates.indexOf(_date) > -1) {
                                // If the date/time has already been found,
                                // then remove the HR element to group it with
                                // the previous (same) items
                                $this.find("hr").remove();
                                $this.find(".gcf-item-daterange").addClass("hidden");
                            } else {
                                // Otherwise, add the date/time as a new entry
                                // with the found_dates array
                                found_dates.push(_date);

                                // Use this element as a daterange group header
                                // for other elements

                                // Remove the bottom HR element
                                $this.find("hr").remove(); // Remove bottom
                                // Clone this element and add it after itself
                                // and hide the daterange element of the clone
                                // (use the daterange element of the original
                                // as the header)
                                $this.after($this.clone()
                                    .find(".gcf-item-daterange").addClass("hidden")
                                    .parents(".gcf-item-block"));
                                $this.find(".gcf-item-title, .gcf-item-location").remove();
                                $this.removeClass("disabled");
                            
                                // and add another at the top of the element
                                $this.prepend("<hr />"); // Add at top
                                $this.removeAttr("data-event-id");
                            }
                            // Hide the description as it is not supported with
                            // tasks
                            $this.find(".gcf-item-description").addClass("hidden");
                        });
                        loadComplete($items);
                        //$("body").addClass("loaded"); // hide the loading screen
                        //hideScrollButtons($items.length <= 1);
                    };
                    break;
                case "ticker":
                    // use the agenda as a news ticker (vertical scrolling,
                    // supports only date, title and location)
                    $('#gcf-custom-template').addClass("ticker");

                    callback = function () {
                        var found_dates = [],
                            $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            var $this = $(this),
                                $desc = $this.find(".gcf-item-description");
                            // Remove all HR and BR from item to keep all at
                            // the same line (inline)
                            $this.find("hr").remove();
                            $this.find("br").remove();
                            // Hide the description to keep all at the same line
                            //$this.find(".gcf-item-description").addClass("hidden");
                            if (!$desc.hasClass("hidden") && $desc.text()) {
                                // Convert description text to HTML. But only
                                // when the Description is not hidden.
                                $desc.html($.parseHTML($desc.text()));
                            }
                        });
                        loadComplete($items);
                        //$("body").addClass("loaded");
                        //hideScrollButtons($items.length <= 1);
                    };
                    break;
                case "ticker-marquee":
                    autoscroll = false; // Disable it, prevents reloads
                    $(".scroll_btns").addClass("hidden");
                    // use the agenda as a news ticker (horizontal scrolling)
                    $('#gcf-custom-template').addClass("ticker").addClass("marquee");

                    callback = function () {
                        var found_dates = [],
                            $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            var $this = $(this),
                                $desc = $this.find(".gcf-item-description");
                            // Remove all HR and BR from item to keep all at
                            // the same line (inline)
                            $this.find("hr").remove();
                            $this.find("br").remove();
                            // Hide the description to keep all at the same line
                            //$this.find(".gcf-item-description").addClass("hidden");
                            if (!$desc.hasClass("hidden") && $desc.text()) {
                                // Remove all HTML tags from the description text
                                // and convert it to plain text. But only when 
                                // the Description is not hidden.
                                $desc.text(plaintext($.parseHTML($desc.text())));
                                //$desc.html($.parseHTML($desc.text()));
                            }
                        });
                        // Marquee Scroll Animation Setup

                        // Get the width of the Container Block
                        var contWidth = $(".gcf-item-container-block").innerWidth();
                        var $lastElem = $items.last(); // Get the last Item
                        // Calculate the end scroll position of the marquee
                        var scrollLeft = $lastElem.position().left + $lastElem.innerWidth() + contWidth;
                        // Add a transparent left border, with a width equal to
                        // the container block, to the first item.
                        // This makes the marquee to start scrolling just outside
                        // the right side.
                        $items.first().css("border-left", "solid transparent " + contWidth + "px");
                        // Do the same width the last item, but here add a right
                        // border instead.
                        // This makes the marquee end scrolling just outside the
                        // left side.
                        $lastElem.css("border-right", "solid transparent " + contWidth + "px");
                        // Calculate the duration based on the scrollLeft and
                        // the SCROLL_INTERVAL ("INTERVAL") parameter.
                        // The calculation keeps the speed constant despite
                        // different lengths of the scrollLeft and values of the
                        // SCROLL_INTERVAL.
                        var duration = parseInt(((scrollLeft / (1.0 / SCROLL_INTERVAL))) * 1.0);
                        // Function that scrolls the ticker with a marquee
                        // animation effect and restarts the animation on end
                        var scrollMarquee = function () {
                            // Animate the Container Block scrollLeft position
                            // with "linear" acceleration
                            /*$(".gcf-item-container-block").animate({
                                scrollLeft: scrollLeft
                            }, duration, "linear", function () {
                                // Reset the scrollLeft position
                                $(".gcf-item-container-block").scrollLeft(0);
                                scrollMarquee(); // Restart the animation
                            });*/
                            // Animate the Container Block x position with
                            // "linear" acceleration using the jquery.transit
                            // plugin (for smooth animation)
                            $(".gcf-item-container-block").transition({
                                x: -scrollLeft
                            }, duration, "linear", function () {
                                // Reset the x position
                                $(".gcf-item-container-block").css({
                                    transform: "translate(0px, 0px)"
                                });
                                ResponsiveTabbedNavigation_NextTab();
                                scrollMarquee(); // Restart the animation
                            });
                        };
                        scrollMarquee(); // Start the marquee animation
                        loadComplete($items);
                        //$("body").addClass("loaded"); // hide the loading screen
                        //hideScrollButtons($items.length <= 1);
                    };
                    break;
            }
            if (!!autoscroll) {
                $(".scroll_btns").addClass("hidden");
            }
            moment.locale(LANG); // Use the current LANG as the moment locale
            // Use the current LANG as the preferred language of the commonly
            // used texts
            $("#gcf-custom-template").attr("data-lang", LANG);
            if (!!NUM_DAYS && +NUM_DAYS > 0) {
                // If NUM_DAYS is set to a value AND it is greater than 0, then
                // Set "dtend" to the end of day of "NUM_DAYS - 1"
                dtend = moment().endOf('day').add(+NUM_DAYS - 1, 'days');
            }
            $('#gcf-custom-template').gCalFlow({
                apikey: API_KEY, // Defined in "private.js" (not included)
                auto_scroll: autoscroll,
                scroll_interval: +SCROLL_INTERVAL * 1000,
                link_title: false, // Do not use links with title
                link_item_title: false, // Do not use links with item title
                data_url: DATA_URL,
                dtstart: dtstart, // Custom option
                dtend: dtend, // Custom option
                calid: encodeURIComponent(CAL_ID || '2dpnd6bnab0bsih2f7fkn45l8o@group.calendar.google.com'),
                maxitem: +MAX_ITEMS,
                date_formatter: function (d, allday_p) {
                    if (allday_p) {
                        // If the event is all day, then return a date formatted
                        // string
                        return moment(d).format(DATE_FORMAT);
                    } else if (moment(d).diff(moment(), 'days') >= 6) {
                        // If the event is NOT all day, but the date is greater
                        // than 5 days in the future, then return a date
                        // formatted string
                        return moment(d).format(DATE_FORMAT);
                    } else {
                        // Otherwise return a calendar formatted date time
                        return moment(d).calendar();
                    }
                },
                daterange_formatter: function (start_d, end_d, allday_p) {
                    var start, end;
                    if (allday_p) {
                        start = moment(start_d); //.format("ddd, ll");
                        if (show_enddate &&
                            moment(end_d).diff(start, 'days') > 1) {
                            // If the end_d is more than a day after start,
                            // then initialize end from end_d and subtract 1
                            // day from it (prevents overflow)
                            end = moment(end_d).subtract(1, 'days'); //.format("ddd, ll");
                        }
                        // Check if event spans from the start of week to the
                        // end of week (locale-aware)
                        if (start.weekday() == 0 && (end && end.weekday() == 6)) {
                            // If the start is at the first weekday and the end
                            // is initialized and at the last weekday then
                            // return a string with the current (locale aware)
                            // week number
                            return "<span class=\"week\">" + start.week() + "</span>"; //"Uke " + start.week();
                        } else {
                            // Otherwise format the start and the end
                            start = start.format(DATE_FORMAT);
                            // Only format the end if it is actually initialized
                            end = end && end.format(DATE_FORMAT);
                        }
                        // Return a string in the format "<start> - <end>" if
                        // both start and end is set to a value.
                        // If end is not set to a value only return "<start>"
                        return start + (end ? " - " + end : "");
                        //+ " - " + moment(end_d).subtract(1, 'days').format("ddd, ll");
                    } else if (moment(start_d).diff(moment(), 'days') >= 6) {
                        // If the event is not all day and the start_d is more
                        // than 5 days in the future, then return a formatted
                        // date string
                        return moment(start_d).format(DATE_FORMAT);
                    } else {
                        if (show_enddate) {
                            end = moment(end_d).format("LT");
                        }
                        // Otherwise return a calendar formatted start_d + a
                        // locale aware time formatted end_d in the form of
                        // "<start_d> - <end>"
                        return moment(start_d).calendar()
                            + (end ? " - " + end : "");
                    }
                },
                callback: callback || function () {
                    var $items = this.find(".gcf-item-block");
                    $items.each(function (index) {
                        var $this = $(this),
                            $desc = $this.find(".gcf-item-description");
                        if (!$desc.hasClass("hidden") && $desc.text()) {
                            // Convert description text to HTML. But only
                            // when the Description is not hidden.
                            $desc.html($.parseHTML($desc.text()));
                        }
                    });
                    loadComplete($items);
                    //$("body").addClass("loaded");
                }
            });

            $('#gcf-custom-template').on("click", "#scroll_up", function (e) {
                e.preventDefault();
                //$root = $('#gcf-custom-template .gcf-item-container-block');
                //$root.scrollTop($root.scrollTop() - 42);
                scrollList(true);
            });
            $('#gcf-custom-template').on("click", "#scroll_dn", function (e) {
                e.preventDefault();
                //$root = $('#gcf-custom-template .gcf-item-container-block');
                //$root.scrollTop($root.scrollTop() + 42);
                scrollList(false);
            });
        }
    </script>
    <style type="text/css">
        h2 {
            clear: both;
            margin-top: 2em;
        }

        #gcf-design .gcf-header-block {
            background: green;
            filter: none;
        }

        #gcf-design {
            height: 300px;
            width: 500px;
            background: #F0FFEE;
            filter: none;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="agenda.css">

    <div id="gcf-custom-template" data-lang="en" data-exprop-task-state="">
        <div class="gcf-header-block">
            <div class="gcf-title-block">
                <span class="gcf-title"></span>
                <span class="scroll_btns">
                    <a id="scroll_up">
                        <i class="fa fa-angle-double-up fa-fw"></i>
                    </a>
                    &nbsp;|&nbsp;
                    <a id="scroll_dn">
                        <i class="fa fa-angle-double-down fa-fw"></i>
                    </a>
                </span>
            </div>
        </div>
        <ul class="gcf-item-container-block">
            <li class="gcf-item-block" data-event-id="null">
                <div class="gcf-item-header-block">
                    <span class="gcf-item-daterange"></span><br />
                    <span class="gcf-item-title"></span><br />
                    <span class="gcf-item-location"></span>
                    <div class="gcf-item-description"></div>
                </div>
                <hr />
            </li>
        </ul>
        <div class="gcf-last-update-block hidden">
            LastUpdate: <span class="gcf-last-update">2012-02-30 20:58</span>
        </div>
    </div>
</body>
</html>
