<html>
<head>
    <!--
        Supports the following URI Query Parameters:
        * CAL_ID : (required) the ID of the Calendar from the Google Calendar
          Service
        * DATE_FORMAT : (optional) the Moment.js format to use with the dates
            * Default : "ddd, ll"
        * LANG : (optional) the language to use with Moment.js
            * Default : nb (Norwegian Bokmaal)
        * TYPE : (optional) type of agenda (normal/grouped)
            * normal : normal agenda (default)
            * grouped : group agenda items by date range (supports only date +
              title)
            * tasks : use the agenda as a simple tasks/todo list (supports only
              date, title and location)
            * ticker : use the agenda as a news ticker (supports only date,
              title and location)
        * INTERVAL : (optional) the scroll interval in seconds
            * Default : 10
        * MAX_ITEMS : (optional) the number of max items to fetch from the
          calendar
            * Default : 50
        * NUM_DAYS : (optional) the number of days in the future to fetch
          events from the calendar.
          - If this is not specified, then MAX_ITEMS is used instead.
          - The value must to be greater than "0". If not, the value will be
            forced to "1"
        * FA_ICON : (optional) the Font Awesome icon to use together with the
          Title/Header block. This could be any name or alias of an icon that
          is included with Font Awesome 4.5.0 (like "calendar").
        * HIDE : (optional) what event item parts should be hidden? A comma
          separated value list of parts to hide.
            * "title" : hide the event title/summary
            * "location" : hide the event location
            * "daterange" : hide the start and end date/time of the event
            * "description" : hide the event description
            * Default : "description" (hide the description if not set)


        Examples:
            agenda.html?CAL_ID=<my_calendar_id>&LANG=en&DATE_FORMAT=lll
              * Agenda with English date and time, with a medium length,
                localized date format
            agenda.html?CAL_ID=<my_calendar_id>&LANG=da&DATE_FORMAT=lll&TYPE=grouped
              *  Grouped agenda with Danish date and time, and a medium length,
                 localized date format
    -->
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href="jquery-gcal-flow-3.0.2/jquery.gcal_flow.css" rel="stylesheet" type="text/css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
        _gCalFlow_debug = true;
    </script>
    <script type="text/javascript" src="../shared/lib/moment-with-locales.min.js" charset="UTF-8"></script>
    <script type="text/javascript" src="private.js" charset="utf-8"></script>
    <!--<script type="text/javascript" src="jquery-gcal-flow-3.0.1/jquery.gcal_flow.js"></script>-->
    <script type="text/javascript" src="jquery.gcal_flow_custom.js"></script>
    <script type="text/javascript">
        /**
         * <http://stackoverflow.com/a/5158301>
         */
        function getParameterByName(name) {
            var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }

        var $ = jQuery;
        $(function () {
            var API_KEY = window.GOOGLE_CALENDAR_API_KEY || null;

            var CAL_ID = getParameterByName("CAL_ID");
            var DATA_URL = getParameterByName("DATA_URL");
            var DATE_FORMAT = getParameterByName("DATE_FORMAT") || "ddd, ll";
            var LANG = getParameterByName("LANG") || "nb";
            var TYPE = getParameterByName("TYPE") || null;
            var SCROLL_INTERVAL = getParameterByName("INTERVAL") || 10;
            var MAX_ITEMS = getParameterByName("MAX_ITEMS") || 50;
            var NUM_DAYS = getParameterByName("NUM_DAYS") || null;
            var FA_ICON = getParameterByName("FA_ICON") || null;
            var HIDE = (getParameterByName("HIDE") || "description").split(",");
            var dtstart = new Date();
            var dtend = null;
            var autoscroll = true;
            var callback = null;
            if (NUM_DAYS !== null && +NUM_DAYS < 1) {
                NUM_DAYS = 1;
            }
            if (FA_ICON) {
                $(".gcf-title-block").prepend("&nbsp;<i class=\"fa fa-" + FA_ICON + "\">&nbsp;</i>");
            }
            $.each(HIDE, function (index, hide) {
                switch (hide) {
                    case "title":
                        $(".gcf-item-title").addClass("hidden");
                        break;
                    case "location":
                        $(".gcf-item-location").addClass("hidden");
                        // Remove the BR before location to move the elements 
                        // following a bit upwards
                        $(".gcf-item-location").prev("br").remove(); 
                        break;
                    case "daterange":
                        $(".gcf-item-daterange").addClass("hidden");
                        break;
                    case "description":
                        $(".gcf-item-description").addClass("hidden");
                        break;
                }
            });

            switch (TYPE) {
                case "grouped":
                    callback = function () {
                        var found_dates = [];
                        var $items = this.find(".gcf-item-block");
                        $items.each(function (index) {
                            var $this = $(this),
                                $date = $this.find(".gcf-item-daterange"),
                                _date = $date.text(),
                                $title = $this.find('.gcf-item-title'),
                                $location = $this.find('.gcf-item-location'),
                                $desc = $this.find(".gcf-item-description"),
                                $prev = $this.prev(),
                                $prev_title = $prev.find('.gcf-item-title'),
                                $prev_location = $prev.find('.gcf-item-location');
                            if (!$desc.hasClass("hidden") && $desc.text()) {
                                // Convert description text to HTML. But only 
                                // when the Description is not hidden.
                                $desc.html($.parseHTML($desc.text()));
                            }
                            if (found_dates.indexOf(_date) > -1) {
                                // If the date of the current item is already
                                // fouund, then group it with the previous
                                //$this.find(".gcf-item-daterange").text("");
                                //$this.find("hr").remove();

                                if ($prev_title.text() != $title.text() &&
                                    $location.text() == $prev_location.text()) {
                                    // The title is different from previous,
                                    // but the location is the same:
                                    // - append the title to the previous
                                    $prev_title.append('<br/>')
                                        .append($title.text());
                                    $this.remove();
                                } else if ($prev_title.text() == $title.text() &&
                                    $location.text() != $prev_location.text()) {
                                    // The location is different from previous,
                                    // but the title is the same:
                                    // - append the location to the previous
                                    $prev_location.append('<br/>')
                                        .append($location.text());
                                    $this.remove();
                                } else {
                                    // Both title AND location is different
                                    // from the previous - Do nothing...
                                }
                                //$this.html("").addClass("hidden");
                                //$this.remove();
                            } else {
                                // If the date of the current item is not already
                                // found, then add it as a new entry to the
                                // "found_dates" array
                                found_dates.push(_date);
                                // Remove the HR from the item and prepend a new
                                // HR to the item
                                $this.find("hr").remove();
                                $this.prepend("<hr />");
                            }
                            if (NUM_DAYS == 1) {
                                $date.addClass("hidden");
                                $this.find("hr").remove();
                                $this.find("br:first").remove();
                            }
                        });
                    };
                    break;
                case "tasks":
                    autoscroll = false;
                    // Set the dtstart to the start of the day
                    dtstart.setHours(0);
                    dtstart.setMinutes(0);
                    dtstart.setSeconds(0);
                    dtstart.setMilliseconds(0);
                    //dtend = moment(dtstart).endOf('day').toDate();
                    // Default NUM_DAYS to 1 of not already set to a value
                    NUM_DAYS = NUM_DAYS || 1;
                    $('#gcf-custom-template').on('click', '.gcf-item-block', function (e) {
                        var $this = $(this); // The task item
                        // The key to use with localStorage
                        var key = "agenda-tasks-" + $this.data("event-id") + "_done";
                        // Toogle DONE state of the task item when clicked/tapped
                        $this.toggleClass("disabled");
                        // Store the serialized task done state (has "disabled"
                        // class) in localStorage
                        localStorage.setItem(key, JSON.stringify($this.hasClass("disabled")));
                    });
                    $('#gcf-custom-template').addClass("tasks");

                    callback = function () {
                        var found_dates = [];
                        this.find(".gcf-item-block").each(function (index) {
                            // Loop through each task item and check for stored
                            // DONE state
                            var $this = $(this); // The task item
                            // The key to use with localStorage
                            var key = "agenda-tasks-" + $this.data("event-id") + "_done";
                            // Check if key exists in localStorage
                            if (key in localStorage) {
                                // Then check its parsed value
                                if (!!JSON.parse(localStorage.getItem(key))) {
                                    // If the parsed value validates to true,
                                    // then set the task as already done (add
                                    // "disabled" class)
                                    $this.addClass("disabled");
                                }
                            }
                            var _date = $this.find(".gcf-item-daterange").text();
                            if (found_dates.indexOf(_date) > -1) {
                                // If the date/time has already been found,
                                // then remove the HR element to group it with
                                // the previous (same) items
                                $this.find("hr").remove();
                            } else {
                                // Otherwise, add the date/time as a new entry
                                // with the found_dates array
                                found_dates.push(_date);
                                // Remove the bottom HR element and add another
                                // at the top of the element
                                $this.find("hr").remove(); // Remove bottom
                                $this.prepend("<hr />"); // Add at top
                            }
                            // Hide the description as it is not supported with
                            // tasks
                            $this.find(".gcf-item-description").addClass("hidden");
                            // Remove the BR elements to keep all elements on
                            // the same line within the item
                            $this.find("br").remove();
                        });
                    };
                    break;
                case "ticker":
                    $('#gcf-custom-template').addClass("ticker");

                    callback = function () {
                        var found_dates = [];
                        this.find(".gcf-item-block").each(function (index) {
                            var $this = $(this);
                            // Remove all HR and BR from item to keep all at
                            // the same line (inline)
                            $this.find("hr").remove();
                            $this.find("br").remove();
                            // Hide the description to keep all at the same line
                            $this.find(".gcf-item-description").addClass("hidden");
                        });
                    };
                    break;
            }
            moment.locale(LANG); // Use the current LANG as the moment locale
            // Use the current LANG as the preferred language of the commonly
            // used texts
            $("#gcf-custom-template").attr("data-lang", LANG);
            if (!!NUM_DAYS && +NUM_DAYS > 0) {
                // If NUM_DAYS is set to a value AND it is greater than 0, then
                // Set "dtend" to the end of day of "NUM_DAYS - 1"
                dtend = moment().endOf('day').add(+NUM_DAYS - 1, 'days');
            }
            $('#gcf-custom-template').gCalFlow({
                apikey: API_KEY, // Defined in "private.js" (not included)
                auto_scroll: autoscroll,
                scroll_interval: +SCROLL_INTERVAL * 1000,
                link_title: false, // Do not use links with title
                link_item_title: false, // Do not use links with item title
                data_url: DATA_URL,
                dtstart: dtstart, // Custom option
                dtend: dtend, // Custom option
                calid: encodeURIComponent(CAL_ID || '2dpnd6bnab0bsih2f7fkn45l8o@group.calendar.google.com'),
                maxitem: +MAX_ITEMS,
                date_formatter: function (d, allday_p) {
                    if (allday_p) {
                        // If the event is all day, then return a date formatted
                        // string
                        return moment(d).format(DATE_FORMAT);
                    } else if (moment(d).diff(moment(), 'days') >= 6) {
                        // If the event is NOT all day, but the date is greater
                        // than 5 days in the future, then return a date
                        // formatted string
                        return moment(d).format(DATE_FORMAT);
                    } else {
                        // Otherwise return a calendar formatted date time
                        return moment(d).calendar();
                    }
                },
                daterange_formatter: function (start_d, end_d, allday_p) {
                    var start, end;
                    if (allday_p) {
                        start = moment(start_d); //.format("ddd, ll");
                        if (moment(end_d).diff(start, 'days') > 1) {
                            // If the end_d is more than a day after start,
                            // then initialize end from end_d and subtract 1
                            // day from it (prevents overflow)
                            end = moment(end_d).subtract(1, 'days'); //.format("ddd, ll");
                        }
                        // Check if event spans from the start of week to the
                        // end of week (locale-aware)
                        if (start.weekday() == 0 && (end && end.weekday() == 6)) {
                            // If the start is at the first weekday and the end
                            // is initialized and at the last weekday then
                            // return a string with the current (locale aware)
                            // week number
                            return "<span class=\"week\">" + start.week() + "</span>"; //"Uke " + start.week();
                        } else {
                            // Otherwise format the start and the end
                            start = start.format(DATE_FORMAT);
                            // Only format the end if it is actually initialized
                            end = end && end.format(DATE_FORMAT);
                        }
                        // Return a string in the format "<start> - <end>" if
                        // both start and end is set to a value.
                        // If end is not set to a value only return "<start>"
                        return start + (end ? " - " + end : "");
                        //+ " - " + moment(end_d).subtract(1, 'days').format("ddd, ll");
                    } else if (moment(start_d).diff(moment(), 'days') >= 6) {
                        // If the event is not all day and the start_d is more
                        // than 5 days in the future, then return a formatted
                        // date string
                        return moment(start_d).format(DATE_FORMAT);
                    } else {
                        // Otherwise return a calendar formatted start_d + a
                        // locale aware time formatted end_d in the form of
                        // "<start_d> - <end_d>"
                        return moment(start_d).calendar()
                            + " - " + moment(end_d).format("LT");
                    }
                },
                callback: callback || function () {
                    var $items = this.find(".gcf-item-block");
                    $items.each(function (index) {
                        var $this = $(this),
                            $desc = $this.find(".gcf-item-description");
                        if (!$desc.hasClass("hidden") && $desc.text()) {
                            // Convert description text to HTML. But only 
                            // when the Description is not hidden.
                            $desc.html($.parseHTML($desc.text()));
                        }
                    });
                }
            });
        });
    </script>
    <style type="text/css">
        h2 {
            clear: both;
            margin-top: 2em;
        }

        #gcf-design .gcf-header-block {
            background: green;
            filter: none;
        }

        #gcf-design {
            height: 300px;
            width: 500px;
            background: #F0FFEE;
            filter: none;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="agenda.css">
</head>
<body>
    <div id="gcf-custom-template" data-lang="en">
        <div class="gcf-header-block">
            <div class="gcf-title-block">
                <span class="gcf-title"></span>
            </div>
        </div>
        <ul class="gcf-item-container-block">
            <li class="gcf-item-block" data-event-id="null">
                <div class="gcf-item-header-block">
                    <span class="gcf-item-daterange"></span><br />
                    <span class="gcf-item-title"></span><br />
                    <span class="gcf-item-location"></span>
                    <div class="gcf-item-description"></div>
                </div>
                <hr />
            </li>
        </ul>
        <div class="gcf-last-update-block hidden">
            LastUpdate: <span class="gcf-last-update">2012-02-30 20:58</span>
        </div>
    </div>
</body>
</html>
